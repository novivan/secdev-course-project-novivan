name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          **/__pycache__
        key: ${{ runner.os }}-python-${{ matrix.python-version }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ matrix.python-version }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt

    - name: Run tests with coverage
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        DATABASE_URL: sqlite:///./test.db
      run: |
        pytest --cov=app --cov-report=xml --cov-report=html -v

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          coverage.xml
          htmlcov/
        retention-days: 7

  ci_cd_build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t secdev-app:${{ github.sha }} -t secdev-app:latest .

    - name: Test Docker image
      run: |
        docker run --rm -d -p 8000:8000 --name test-container secdev-app:latest
        sleep 10
        docker logs test-container
        docker stop test-container

    - name: Save Docker image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: |
          Dockerfile
          .dockerignore
        retention-days: 30

  security-scan:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        pip install bandit safety
        bandit -r app/ -f html -o security-report.html || true
        safety check -r requirements.txt --output text || true

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          security-report.html
        retention-days: 7

  deploy-simulation:
    runs-on: ubuntu-latest
    needs: [test, ci_cd_build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Simulate deployment to staging
      env:
        DEPLOY_ENV: staging
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'sqlite:///./prod.db' }}
      run: |
        echo " Starting deployment simulation to $DEPLOY_ENV"
        echo " Application: Feature Voting System"
        echo " Using secrets: JWT_SECRET=[hidden], DATABASE_URL=[hidden]"
        echo " Deployment simulation completed successfully!"
        echo " Mock endpoint: https://staging-feature-voting.example.com"

    - name: Generate deployment report
      run: |
        cat > deploy-report.md << EOF
        # Deployment Simulation Report
        - **Application**: Feature Voting System
        - **Environment**: staging
        - **Status**: Success
        - **Timestamp**: $(date -u)
        - **Commit**: ${{ github.sha }}
        EOF

    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-reports
        path: deploy-report.md
        retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: [test, ci_cd_build, deploy-simulation]
    if: always()

    steps:
    - name: Notify status
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.ci_cd_build.result }}" == "success" ] ||
           [ "${{ needs.ci_cd_build.result }}" == "skipped" ]; then
          echo "All checks passed!"
        else
          echo "Some checks failed"
          exit 1
        fi
